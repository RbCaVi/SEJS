<html>
	<head>
    <link rel="stylesheet" href="accordion.css">
    <link rel="stylesheet" href="wiki.css">
    <link rel="stylesheet" href="style.css">
	</head>
	<body>
		<script type='module'>
			import {util,resolveAll} from './util.js';
			window.util=util;
			window.modules={};
		  import * as mdata from './data.js';
		  modules.data=mdata;
		  import * as mimage from './image.js';
		  modules.image=mimage;
		  import * as mnormalize from './normalize.js';
		  modules.normalize=mnormalize;
		  import * as mprocess from './process.js';
		  modules.process=mprocess;
		  import * as mtowiki from './towiki.js';
		  modules.towiki=mtowiki;
		  import * as mutil from './util.js';
		  modules.util=mutil;
		  import * as mwikiapi from './wikiapi.js';
		  modules.wikiapi=mwikiapi;
		  import * as meditjson from './editjson.js';
		  modules.editjson=meditjson;
		  import * as msimplex from './simplex.js';
		  modules.simplex=msimplex;
		  import * as mrational from './rational.js';
		  modules.rational=mrational;
		  import * as maccordion from './accordion.js';
		  modules.accordion=maccordion;
		  import * as mlocale from './locale.js';
		  modules.locale=mlocale;
		  //import * as m from './.js';
		  //modules.=m;
		  window.wiki='https://spaceexploration.miraheze.org';
			var datap=fetch('SE.json').then(r=>r.json()).then(data=>{
				window.data=new modules.data.FactorioData(data);
				return window.data;
			});
			var localep=fetch('SElocale.json').then(r=>r.json()).then(locale=>{
				window.locale=new modules.locale.FactorioLocale(locale);
				return window.locale;
			});
			resolveAll({'data':datap,'locale':localep}).then(d=>{
				window.localizer=new modules.locale.FactorioLocalizer(d.data,d.locale);
			}).then(()=>{
				window.itemlocales={};
				window.recipelocales={};
				for(var itype of util.itemtypes){
					for(var name of Object.keys(data.data[itype])){
						itemlocales[name]=localizer.itemlocale(name);
					}
				}
				for(var name of Object.keys(data.data.recipe)){
					recipelocales[name]=localizer.recipelocale(name);
				}
			});
		</script>
		<script>
			function match(pattern,s){
				pattern=pattern.toLowerCase();
				s=s.toLowerCase();
				var patterni=0;
				var matches=[];
				for(var i=0;i<s.length;i++){
					if(s.charAt(i)==pattern.charAt(patterni)){
						matches.push(i);
						patterni++;
						if(patterni==pattern.length){
							console.log(matches);
							return [true,matches];
						}
					}
				}
				return [false,[]];
			}

			function comparematch(m1,m2){
				if(m1.length!=m2.length){
					throw 'unmatched lengths';
				}
				for(var i=0;i<m1.length;i++){
					if(m1[i]<m2[i]){
						return -1;
					}else if(m1[i]>m2[i]){
						return 1;
					}
				}
				return 0;
			}

			function compare([,,im1,lm1],[,,im2,lm2]){
				// compare the locale match first
				var empty1=lm1.length==0;
				var empty2=lm2.length==0;
				if(empty1){
					if(empty2){
						return comparematch(im1,im2);
					}else{
						return 1;
					}
				}else{
					if(empty2){
						return -1;
					}else{
						var match=comparematch(lm1,lm2);
						if(match==0){
							return comparematch(im1,im2);
						}
						return match;
					}
				}
			}

			function locationOf(element, array, compare, start, end) {
			  var start = start || 0;
			  var end = end || array.length;
			  var pivot = (start+end)>>1;
			  if (end - start <= 1)
			    return array[pivot] > element ? pivot - 1 : pivot;
				var comp=compare(array[pivot],element);
			  if (comp==0) return pivot;
			  if (comp<0) {
			    return locationOf(element, array, compare, pivot, end);
			  } else {
			    return locationOf(element, array, compare, start, pivot);
			  }
			}

			function insort(array, element, compare) {
				var loc=locationOf(element, array, compare);
			  array.splice(loc + 1, 0, element);
			  return array;
			}

			function itemsearch(element){
				var search=element.value;
				var scores=[];
				for(var [iname,[lname,ldesc]] of Object.entries(itemlocales)){
					var [imatched,imatch]=match(search,iname);
					var [lmatched,lmatch]=match(search,lname);
					if(imatched||lmatched){
						insort(scores,[iname,lname,imatch,imatch],compare);
					}
				}
				console.log(scores);
			}
		</script>
		<script>
			function getimage(data,size) {
	      var img=document.createElement('img');
	      document.querySelector('body').append(img);
		    return modules.image.makeiconURL(data,size).then(url=>{
		      img.src=url;
		    });
		  }

			function addstyles(element,styles){
				// styles is {style name:style value}
				for(var [key,value] of Object.entries(styles)){
					element.style[key]=value;
				}
			}

			function addclasses(element,classes){
				// classes is [class...]
				for(var c of classes){
					element.classList.add(c);
				}
			}

			function renderstructure(structure){
				var out;
				if(typeof structure=='string'||typeof structure=='number'){
					return structure;
				}
				if('contents' in structure){
					structure.contents=structure.contents.flat();
				}
				if(structure.type=='accordion'){
					if('header' in structure){
						var headerparts=structure.header.map(renderstructure);
						var header=document.createElement('span');
						header.append(...headerparts);
					}
					var contents=structure.contents.map(renderstructure);
					var div=document.createElement('div');
					div.append(...contents);
					out=modules.accordion.createaccordion(header,div);
				}else if(structure.type=='editjson'){
					out=modules.editjson.fromjson(structure.data);
				}else if(structure.type=='json'){
					out=modules.accordion.fromjson(structure.data);
				}else if(structure.type=='icon'){
					// promise to load the image
					var img=document.createElement('img');
					var idata;
					if(structure.itype=='item'){
						idata=data.getitem(structure.name);
					}else if(structure.itype=='tech'){
						idata=data.data.technology[structure.name];
					}else if(structure.itype=='recipe'){
						var rdata=data.data.recipe[structure.name];
						console.log(rdata);
						if(rdata.icons==undefined&&rdata.icon==undefined){
							if(rdata.normal.main_product){
								idata=data.getitem(rdata.normal.main_product);
							}else if(rdata.normal.result){
								idata=data.getitem(rdata.normal.result);
							}else{
								idata=data.getitem(rdata.normal.results[0].name);
							}
						}else{
							idata=rdata;
						}
					}
					modules.image.makeiconURL(idata).then(url=>{
			      	img.src=url;
					});
					var iconstyle={
						borderColor:'black',
						borderWidth:'1px',
						borderStyle:'solid',
						position:'relative',
						display:'inline-block'
					};
					addstyles(img,iconstyle);
					var itype=structure.itype;
					var name=structure.name;
					img.addEventListener('click',()=>render(itype,name));
					out=img;
				}else{
					var contents=structure.contents.map(renderstructure);
					var container=document.createElement(structure.type);
					container.append(...contents);
					out=container;
				}
				if('classes' in structure){
					addclasses(out,structure.classes);
				}
				if('styles' in structure){
					addstyles(out,structure.styles);
				}
				return out;
			}

			function recipetostructure(recipe){
				var rdata=data.pdata.recipe[recipe];
				var ings=rdata.normal.ingredients;
				var ress=rdata.normal.results;
				var iconstyle={
					borderColor:'black',
					borderWidth:'1px',
					borderStyle:'solid',
					position:'relative',
					display:'inline-block'
				};
				var ingcontents=[];
				for(var i=0;i<ings.length;i++){
					ingcontents.push({
						type:'span',
						contents:[
							{type:'icon',itype:'item',name:ings[i][0]},
							{type:'span',contents:[ings[i][1]],classes:['icon-text']}
						],
						styles:iconstyle
					});
					ingcontents.push('+');
				}
				var rescontents=[];
				for(var i=0;i<ress.length;i++){
					rescontents.push({
						type:'span',
						contents:[
							{type:'icon',itype:'item',name:ress[i][0]},
							{type:'span',contents:[ress[i][1]],classes:['icon-text']}
						],
						styles:iconstyle
					});
					rescontents.push('+');
				}
				ingcontents.pop();
				rescontents.pop();
				return ingcontents.concat(['→'],rescontents,' ',rdata.normal.time+' s');
			}

			var arrow='→';

			function accordionifmultiple(header,parts){
				if(parts.length==0){
					return [];
				}
				if(parts.length==1){
					return {type:'div',contents:[header,parts[0]]};
				}
				return {type:'accordion',header:header,contents:parts};
			}
		</script>
		<div class="items"></div>
		<div>
			<div style='width: 50%; float: left;'>
				<h1>Item</h1>
				<input type="text" id='itemsearch' oninput="itemsearch(this)">
			</div>
			<div style='width: 50%; float: right;'>
				<h1>Recipe</h1>
				<input type="text" id='recipesearch'>
				<div class='recipes'></div>
			</div>
		</div>
		<div>
			<button>Make infobox JSON</button>
			<div class='infoboxjson'></div>
		</div>
		<div>
			<button>Make infobox wikitext</button>
			<textarea class='infoboxwikitext'></textarea>
		</div>
		<div>
			search page
			<button>Load wikitext</button>
		</div>
		<div>
			<div>old wikitext<div class='oldwikitext'></div></div>
			<div>new wikitext<textarea class='newboxwikitext'></textarea></div>
		</div>
		<div>
			<div>old preview<div></div></div>
			<div>new preview<div></div></div>
			<button>Reload preview</button>
		</div>
		<!--transform-origin:0 0;-->
	</body>
</html>
