<html>
	<head>
    <link rel="stylesheet" href="accordion.css">
    <link rel="stylesheet" href="style.css">
	</head>
	<body>
		<script type='module'>
			import {FactorioData} from './data.js';
			import {FactorioLocale,FactorioLocalizer} from './locale.js';
			import {util} from './util.js';
			function resolveAll(ps){
			  // ps is {key:promise ...}
			  // returns a Promise that resolves to {key:promise value}
			  // will reject with any error
			  var values={};
			  return Object.entries(ps).map(([k,p])=>p.then(data=>{values[k]=data;})).reduce((p1,p2)=>p1.then(()=>p2)).then(()=>values);
			}
			var datap=fetch('SE.json').then(r=>r.json()).then(data=>{
				window.data=new FactorioData(data);
				return window.data;
			});
			var localep=fetch('SElocale.json').then(r=>r.json()).then(locale=>{
				window.locale=new FactorioLocale(locale);
				return window.locale;
			});
			resolveAll({'data':datap,'locale':localep}).then(d=>{
				window.localizer=new FactorioLocalizer(d.data,d.locale);
			}).then(()=>{
				render('recipe','se-iridium-ingot');
				render('item','se-naquium-processor');
			});
			window.util=util;
		  import * as mdata from './data.js';
		  import * as mimage from './image.js';
		  import * as mnormalize from './normalize.js';
		  import * as mprocess from './process.js';
		  import * as mtowiki from './towiki.js';
		  import * as mutil from './util.js';
		  import * as mwikiapi from './wikiapi.js';
		  window.wiki='https://spaceexploration.miraheze.org';
		  window.mdata=mdata;
			window.mimage=mimage;
			window.mnormalize=mnormalize;
			window.mprocess=mprocess;
			window.mtowiki=mtowiki;
			window.mutil=mutil;
			window.mwikiapi=mwikiapi;
		  import * as maccordion from './accordion.js';
			window.maccordion=maccordion;
		  import * as meditjson from './editjson.js';
			window.meditjson=meditjson;
		  import * as msimplex from './simplex.js';
			window.msimplex=msimplex;
		  import * as mrational from './rational.js';
			window.mrational=mrational;
		  //import * as m from './.js';
			//window.m=m;
		</script>
		<script>
			function getimage(data,size) {
	      var img=document.createElement('img');
	      document.querySelector('body').append(img);
		    return mimage.makeiconURL(data,size).then(url=>{
		      img.src=url;
		    });
		  }

			function addstyles(element,styles){
				// styles is {style name:style value}
				for(var [key,value] of Object.entries(styles)){
					element.style[key]=value;
				}
			}

			function addclasses(element,classes){
				// classes is [class...]
				for(var c of classes){
					element.classList.add(c);
				}
			}

			function renderstructure(structure){
				var out;
				if(typeof structure=='string'||typeof structure=='number'){
					return structure;
				}
				if('contents' in structure){
					structure.contents=structure.contents.flat();
				}
				if(structure.type=='accordion'){
					if('header' in structure){
						var headerparts=structure.header.map(renderstructure);
						var header=document.createElement('span');
						header.append(...headerparts);
					}
					var contents=structure.contents.map(renderstructure);
					var div=document.createElement('div');
					div.append(...contents);
					out=maccordion.createaccordion(header,div);
				}else if(structure.type=='editjson'){
					out=meditjson.fromjson(structure.data);
				}else if(structure.type=='json'){
					out=maccordion.fromjson(structure.data);
				}else if(structure.type=='icon'){
					// promise to load the image
					var img=document.createElement('img');
					var idata;
					if(structure.itype=='item'){
						idata=data.getitem(structure.name);
					}else if(structure.itype=='tech'){
						idata=data.data.technology[structure.name];
					}else if(structure.itype=='recipe'){
						var rdata=data.data.recipe[structure.name];
						console.log(rdata);
						if(rdata.icons==undefined&&rdata.icon==undefined){
							if(rdata.normal.main_product){
								idata=data.getitem(rdata.normal.main_product);
							}else if(rdata.normal.result){
								idata=data.getitem(rdata.normal.result);
							}else{
								idata=data.getitem(rdata.normal.results[0].name);
							}
						}else{
							idata=rdata;
						}
					}
					mimage.makeiconURL(idata).then(url=>{
			      	img.src=url;
					});
					var iconstyle={
						borderColor:'black',
						borderWidth:'1px',
						borderStyle:'solid',
						position:'relative',
						display:'inline-block'
					};
					addstyles(img,iconstyle);
					var itype=structure.itype;
					var name=structure.name;
					img.addEventListener('click',()=>render(itype,name));
					out=img;
				}else{
					var contents=structure.contents.map(renderstructure);
					var container=document.createElement(structure.type);
					container.append(...contents);
					out=container;
				}
				if('classes' in structure){
					addclasses(out,structure.classes);
				}
				if('styles' in structure){
					addstyles(out,structure.styles);
				}
				return out;
			}

			function recipetostructure(recipe){
				var rdata=data.pdata.recipe[recipe];
				var ings=rdata.normal.ingredients;
				var ress=rdata.normal.results;
				var iconstyle={
					borderColor:'black',
					borderWidth:'1px',
					borderStyle:'solid',
					position:'relative',
					display:'inline-block'
				};
				var ingcontents=[];
				for(var i=0;i<ings.length;i++){
					ingcontents.push({
						type:'span',
						contents:[
							{type:'icon',itype:'item',name:ings[i][0]},
							{type:'span',contents:[ings[i][1]],classes:['icon-text']}
						],
						styles:iconstyle
					});
					ingcontents.push('+');
				}
				var rescontents=[];
				for(var i=0;i<ress.length;i++){
					rescontents.push({
						type:'span',
						contents:[
							{type:'icon',itype:'item',name:ress[i][0]},
							{type:'span',contents:[ress[i][1]],classes:['icon-text']}
						],
						styles:iconstyle
					});
					rescontents.push('+');
				}
				ingcontents.pop();
				rescontents.pop();
				return ingcontents.concat(['→'],rescontents,' ',rdata.normal.time+' s');
			}

			function _renderitem(item){
				var structure={
					type:'div',
					contents:[
						localizer.itemlocale(item)[0],
						{type:'span',contents:[item],classes:['internal-name']},
						{type:'icon',itype:'item',name:item},
						{
							type:'accordion',
							header:['Prototype'],
							contents:[
								{
									type:'json',
									data:data.getrawitem(item)
								}
							]
						},
						{
							type:'accordion',
							header:['Produced by'],
							contents:(data.produces.normal[item]??[]).map(recipe=>({
								type:'accordion',
								header:[
									localizer.recipelocale(recipe)[0]??'???',
									{type:'span',contents:[recipe],classes:['internal-name']},
									{type:'icon',itype:'recipe',name:recipe}
								],
								contents:recipetostructure(recipe)
							}))
						},
						{
							type:'accordion',
							header:['Used by'],
							contents:(data.uses.normal[item]??[]).map(recipe=>({
								type:'accordion',
								header:[
									localizer.recipelocale(recipe)[0]??'???',
									{type:'span',contents:[recipe],classes:['internal-name']},
									{type:'icon',itype:'recipe',name:recipe}
								],
								contents:recipetostructure(recipe)
							}))
						}
					]
				};

				var div=renderstructure(structure);
				put(div);
			}

			var arrow='→';

			function accordionifmultiple(header,parts){
				if(parts.length==0){
					return [];
				}
				if(parts.length==1){
					return {type:'div',contents:[header,parts[0]]};
				}
				return {type:'accordion',header:header,contents:parts};
			}

			function _renderrecipe(recipe){
				var structure={
					type:'div',
					contents:[
						localizer.recipelocale(recipe)[0]??'???',
						{type:'span',contents:[recipe],classes:['internal-name']},
						{type:'icon',itype:'recipe',name:recipe},
						{type:'br',contents:[]},
						recipetostructure(recipe),
						accordionifmultiple(
							'Unlocked by ',
							(data.unlockedby.normal[recipe]??[]).map(tech=>({
								type:'span',
								contents:[
									localizer.techlocale(tech)[0],
									{type:'span',contents:[tech],classes:['internal-name']},
									{type:'icon',itype:'tech',name:tech}
								]
							}))
						),
						{
							type:'accordion',
							header:['Prototype'],
							contents:[
								{
									type:'json',
									data:data.rawdata.recipe[recipe]
								}
							]
						}
					]
				};

				var div=renderstructure(structure);
				put(div);
			}

			function rendertech(){}

			function renderentity(){}

			let history=[];
			let fhistory=[];

			function render(type,name){
				history.push([type,name]);
				fhistory=[];
				_render(type,name);
			}

			function _render(type,name) {
				switch(type){
				case 'recipe':
					_renderrecipe(name);
					break;
				case 'item':
					_renderitem(name);
					break;
				}
			}

			function back(){
				if(history.length<=1){
					return;
				}
				var typename=history.pop();
				fhistory.push(typename);
				_render(...history[history.length-1]);
			}

			function forward(){
				if(fhistory.length==0){
					return;
				}
				var typename=fhistory.pop();
				history.push(typename);
				_render(...typename);
			}

			function put(div) {
		    var body=document.querySelector('.items');
			  while (body.firstChild) {
			    body.removeChild(body.lastChild);
			  }
		    body.append(div);
			}

			function getraw(item){
				solver=new msimplex.SimplexSolver(data)
				var outs={};
				outs[item]=-1;
				var result=solver.solve(outs);
				return Object.entries(result).filter(
					x=>x[0].startsWith('recipe.mine.')||x[0].startsWith('recipe.pump.')
				).map(
					([name,amount])=>[name.slice(7),amount]
				).map(
					([name,amount])=>[solver.rtable[name],amount]
				).map(
					([recipe,amount])=>Object.entries(recipe).map(
						([item,iamount])=>[item,mrational.mult(iamount,amount)]
					)
				).flat().map(
					([name,amount])=>[name,amount.num/amount.denom]
				).reduce(
					(o,[name,amount])=>{o[name]=(o[name]??0)+amount;return o;},
					{}
				)
			}

			function renderthing(type) {
				render(type,document.getElementById('inputbox').value);
			}
		</script>
		<button onclick="back()">back</button><button onclick="forward()">forward</button>
		<div class="items"></div>
		<input type="text" id='inputbox'>
		<button onclick="renderthing('item')">item</button><button onclick="renderthing('recipe')">recipe</button>
	</body>
</html>
